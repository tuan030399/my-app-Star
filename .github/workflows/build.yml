name: 🍎 iOS Build - QL Tin Học

on:
  push:
    branches: [ main, master, develop, fresh-start ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  ios-build:
    name: 🍎 Build iOS IPA
    runs-on: macos-latest
    timeout-minutes: 60

    steps:
    - name: 📥 Checkout repository
      uses: actions/checkout@v4

    - name: 🔧 Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        channel: 'stable'
        cache: true

    - name: 📦 Install dependencies
      run: flutter pub get

    - name: 🍎 Setup iOS environment
      run: |
        flutter precache --ios
        cd ios
        pod install --repo-update
        cd ..

    - name: 🏗️ Build iOS app (unsigned)
      run: |
        flutter build ios --release --no-codesign
        
    - name: 📦 Create IPA file
      run: |
        echo "📦 Creating IPA from built app..."
        cd build/ios/iphoneos
        
        # Create Payload directory
        mkdir -p Payload
        
        # Copy Runner.app to Payload
        cp -r Runner.app Payload/
        
        # Create IPA
        zip -r ../../../qltinhoc-ios-unsigned.ipa Payload/
        
        cd ../../..
        
        # Verify IPA was created
        if [ -f "qltinhoc-ios-unsigned.ipa" ]; then
          echo "✅ IPA created successfully!"
          ls -la qltinhoc-ios-unsigned.ipa
        else
          echo "❌ IPA creation failed!"
          exit 1
        fi

    - name: 📊 Build info
      run: |
        echo "🍎 iOS Build Information"
        echo "======================="
        echo "📱 App: QL Tin Học"
        echo "📦 Package: qltinhoc-ios-unsigned.ipa"
        echo "🔧 Build: Release (unsigned)"
        echo "📅 Date: $(date)"
        echo "🔗 Commit: ${{ github.sha }}"
        
        # Show file size
        if [ -f "qltinhoc-ios-unsigned.ipa" ]; then
          echo "📏 Size: $(ls -lh qltinhoc-ios-unsigned.ipa | awk '{print $5}')"
        fi

    - name: 📤 Upload IPA artifact
      uses: actions/upload-artifact@v4
      with:
        name: qltinhoc-ios-unsigned-${{ github.run_number }}
        path: qltinhoc-ios-unsigned.ipa
        retention-days: 30

    - name: 📝 Upload build logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: ios-build-logs-${{ github.run_number }}
        path: |
          ios/Podfile.lock
          build/ios/iphoneos/Runner.app/Info.plist
        retention-days: 7

  # ==================== BUILD VERIFICATION ====================
  verify-build:
    name: ✅ Verify Build
    runs-on: ubuntu-latest
    needs: ios-build
    if: always()

    steps:
    - name: 📥 Download IPA
      if: needs.ios-build.result == 'success'
      uses: actions/download-artifact@v4
      with:
        name: qltinhoc-ios-unsigned-${{ github.run_number }}

    - name: 🔍 Verify IPA
      if: needs.ios-build.result == 'success'
      run: |
        echo "🔍 Verifying IPA file..."
        
        if [ -f "qltinhoc-ios-unsigned.ipa" ]; then
          echo "✅ IPA file exists"
          echo "📏 Size: $(ls -lh qltinhoc-ios-unsigned.ipa | awk '{print $5}')"
          
          # Check if it's a valid ZIP (IPA is a ZIP file)
          if unzip -t qltinhoc-ios-unsigned.ipa > /dev/null 2>&1; then
            echo "✅ IPA is a valid archive"
            
            # List contents
            echo "📦 IPA Contents:"
            unzip -l qltinhoc-ios-unsigned.ipa | head -20
          else
            echo "❌ IPA is corrupted"
            exit 1
          fi
        else
          echo "❌ IPA file not found"
          exit 1
        fi

    - name: 📊 Build Summary
      run: |
        echo "🍎 iOS BUILD SUMMARY"
        echo "==================="
        echo "🏗️ Build Status: ${{ needs.ios-build.result }}"
        echo "📱 App Name: QL Tin Học"
        echo "📦 Output: qltinhoc-ios-unsigned.ipa"
        echo "🔗 Run: ${{ github.run_number }}"
        echo "==================="
        
        if [ "${{ needs.ios-build.result }}" == "success" ]; then
          echo "✅ BUILD SUCCESSFUL!"
          echo "📥 Download IPA from Actions artifacts"
          echo "⚠️  Note: IPA is unsigned - requires signing for device installation"
        else
          echo "❌ BUILD FAILED!"
          echo "📋 Check build logs for details"
        fi
