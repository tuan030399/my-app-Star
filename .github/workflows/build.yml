name: ğŸ iOS Build - QL Tin Há»c

on:
  push:
    branches: [ main, master, develop, fresh-start ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  ios-build:
    name: ğŸ Build iOS IPA
    runs-on: macos-latest
    timeout-minutes: 60

    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4

    - name: ğŸ”§ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        channel: 'stable'
        cache: true

    - name: ğŸ“¦ Install dependencies
      run: flutter pub get

    - name: ğŸ Setup iOS environment
      run: |
        flutter precache --ios
        cd ios
        pod install --repo-update
        cd ..

    - name: ğŸ—ï¸ Build iOS app (unsigned)
      run: |
        flutter build ios --release --no-codesign
        
    - name: ğŸ“¦ Create IPA file
      run: |
        echo "ğŸ“¦ Creating IPA from built app..."
        cd build/ios/iphoneos
        
        # Create Payload directory
        mkdir -p Payload
        
        # Copy Runner.app to Payload
        cp -r Runner.app Payload/
        
        # Create IPA
        zip -r ../../../qltinhoc-ios-unsigned.ipa Payload/
        
        cd ../../..
        
        # Verify IPA was created
        if [ -f "qltinhoc-ios-unsigned.ipa" ]; then
          echo "âœ… IPA created successfully!"
          ls -la qltinhoc-ios-unsigned.ipa
        else
          echo "âŒ IPA creation failed!"
          exit 1
        fi

    - name: ğŸ“Š Build info
      run: |
        echo "ğŸ iOS Build Information"
        echo "======================="
        echo "ğŸ“± App: QL Tin Há»c"
        echo "ğŸ“¦ Package: qltinhoc-ios-unsigned.ipa"
        echo "ğŸ”§ Build: Release (unsigned)"
        echo "ğŸ“… Date: $(date)"
        echo "ğŸ”— Commit: ${{ github.sha }}"
        
        # Show file size
        if [ -f "qltinhoc-ios-unsigned.ipa" ]; then
          echo "ğŸ“ Size: $(ls -lh qltinhoc-ios-unsigned.ipa | awk '{print $5}')"
        fi

    - name: ğŸ“¤ Upload IPA artifact
      uses: actions/upload-artifact@v4
      with:
        name: qltinhoc-ios-unsigned-${{ github.run_number }}
        path: qltinhoc-ios-unsigned.ipa
        retention-days: 30

    - name: ğŸ“ Upload build logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: ios-build-logs-${{ github.run_number }}
        path: |
          ios/Podfile.lock
          build/ios/iphoneos/Runner.app/Info.plist
        retention-days: 7

  # ==================== BUILD VERIFICATION ====================
  verify-build:
    name: âœ… Verify Build
    runs-on: ubuntu-latest
    needs: ios-build
    if: always()

    steps:
    - name: ğŸ“¥ Download IPA
      if: needs.ios-build.result == 'success'
      uses: actions/download-artifact@v4
      with:
        name: qltinhoc-ios-unsigned-${{ github.run_number }}

    - name: ğŸ” Verify IPA
      if: needs.ios-build.result == 'success'
      run: |
        echo "ğŸ” Verifying IPA file..."
        
        if [ -f "qltinhoc-ios-unsigned.ipa" ]; then
          echo "âœ… IPA file exists"
          echo "ğŸ“ Size: $(ls -lh qltinhoc-ios-unsigned.ipa | awk '{print $5}')"
          
          # Check if it's a valid ZIP (IPA is a ZIP file)
          if unzip -t qltinhoc-ios-unsigned.ipa > /dev/null 2>&1; then
            echo "âœ… IPA is a valid archive"
            
            # List contents
            echo "ğŸ“¦ IPA Contents:"
            unzip -l qltinhoc-ios-unsigned.ipa | head -20
          else
            echo "âŒ IPA is corrupted"
            exit 1
          fi
        else
          echo "âŒ IPA file not found"
          exit 1
        fi

    - name: ğŸ“Š Build Summary
      run: |
        echo "ğŸ iOS BUILD SUMMARY"
        echo "==================="
        echo "ğŸ—ï¸ Build Status: ${{ needs.ios-build.result }}"
        echo "ğŸ“± App Name: QL Tin Há»c"
        echo "ğŸ“¦ Output: qltinhoc-ios-unsigned.ipa"
        echo "ğŸ”— Run: ${{ github.run_number }}"
        echo "==================="
        
        if [ "${{ needs.ios-build.result }}" == "success" ]; then
          echo "âœ… BUILD SUCCESSFUL!"
          echo "ğŸ“¥ Download IPA from Actions artifacts"
          echo "âš ï¸  Note: IPA is unsigned - requires signing for device installation"
        else
          echo "âŒ BUILD FAILED!"
          echo "ğŸ“‹ Check build logs for details"
        fi
