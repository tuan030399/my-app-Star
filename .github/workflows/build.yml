name: 🚀 Multi-Platform Build - QL Tin Học

on:
  push:
    branches: [ main, master, develop, fresh-start ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      build_android:
        description: 'Build Android APK'
        required: false
        default: 'true'
        type: boolean
      build_ios:
        description: 'Build iOS IPA'
        required: false
        default: 'true'
        type: boolean
      build_windows:
        description: 'Build Windows EXE'
        required: false
        default: 'true'
        type: boolean

jobs:
  # ==================== ANDROID BUILD ====================
  android-build:
    if: github.event.inputs.build_android != 'false'
    name: 🤖 Android APK Build
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - name: 📥 Checkout Repository
      uses: actions/checkout@v4

    - name: ☕ Setup Java 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: 🔧 Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        channel: 'stable'
        cache: true

    - name: 📦 Get Dependencies
      run: flutter pub get

    - name: 🏗️ Build Android APK
      run: |
        flutter build apk --release
        
    - name: 📝 Rename APK
      run: |
        cp build/app/outputs/flutter-apk/app-release.apk qltinhoc-android.apk
        ls -la *.apk

    - name: 📤 Upload Android APK
      uses: actions/upload-artifact@v4
      with:
        name: qltinhoc-android-${{ github.run_number }}
        path: qltinhoc-android.apk
        retention-days: 30

  # ==================== iOS BUILD ====================
  ios-build:
    if: github.event.inputs.build_ios != 'false'
    name: 🍎 iOS IPA Build
    runs-on: macos-latest
    timeout-minutes: 45

    steps:
    - name: 📥 Checkout Repository
      uses: actions/checkout@v4

    - name: 🔧 Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        channel: 'stable'
        cache: true

    - name: 📦 Get Dependencies
      run: flutter pub get

    - name: 🍎 Setup iOS
      run: |
        flutter precache --ios
        cd ios
        pod install --repo-update
        cd ..

    - name: 🏗️ Build iOS (No Code Sign)
      run: |
        flutter build ios --release --no-codesign
        
    - name: 📦 Create IPA
      run: |
        cd build/ios/iphoneos
        mkdir -p Payload
        cp -r Runner.app Payload/
        zip -r ../../../qltinhoc-ios-unsigned.ipa Payload/
        cd ../../..
        ls -la *.ipa

    - name: 📤 Upload iOS IPA
      uses: actions/upload-artifact@v4
      with:
        name: qltinhoc-ios-${{ github.run_number }}
        path: qltinhoc-ios-unsigned.ipa
        retention-days: 30

  # ==================== WINDOWS BUILD ====================
  windows-build:
    if: github.event.inputs.build_windows != 'false'
    name: 🖥️ Windows EXE Build
    runs-on: windows-latest
    timeout-minutes: 30

    steps:
    - name: 📥 Checkout Repository
      uses: actions/checkout@v4

    - name: 🔧 Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        channel: 'stable'
        cache: true

    - name: 📦 Get Dependencies
      run: flutter pub get

    - name: 🖥️ Enable Windows Desktop
      run: flutter config --enable-windows-desktop

    - name: 🏗️ Build Windows EXE
      run: flutter build windows --release

    - name: 📦 Package Windows App
      run: |
        Compress-Archive -Path "build\windows\x64\runner\Release\*" -DestinationPath "qltinhoc-windows.zip"
        dir *.zip

    - name: 📤 Upload Windows ZIP
      uses: actions/upload-artifact@v4
      with:
        name: qltinhoc-windows-${{ github.run_number }}
        path: qltinhoc-windows.zip
        retention-days: 30

  # ==================== BUILD SUMMARY ====================
  build-summary:
    name: 📋 Build Summary
    runs-on: ubuntu-latest
    needs: [android-build, ios-build, windows-build]
    if: always()

    steps:
    - name: 📊 Build Results
      run: |
        echo "🚀 QL TIN HỌC - BUILD SUMMARY"
        echo "================================"
        echo "🤖 Android: ${{ needs.android-build.result }}"
        echo "🍎 iOS: ${{ needs.ios-build.result }}"
        echo "🖥️ Windows: ${{ needs.windows-build.result }}"
        echo "================================"
        echo "📦 Artifacts will be available for 30 days"
        echo "🔗 Download from Actions tab"
