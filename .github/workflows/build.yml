name: ğŸš€ Multi-Platform Build - QL Tin Há»c

on:
  push:
    branches: [ main, master, develop, fresh-start ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      build_android:
        description: 'Build Android APK'
        required: false
        default: 'true'
        type: boolean
      build_ios:
        description: 'Build iOS IPA'
        required: false
        default: 'true'
        type: boolean
      build_windows:
        description: 'Build Windows EXE'
        required: false
        default: 'true'
        type: boolean

jobs:
  # ==================== ANDROID BUILD ====================
  android-build:
    if: github.event.inputs.build_android != 'false'
    name: ğŸ¤– Android APK Build
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4

    - name: â˜• Setup Java 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: ğŸ”§ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        channel: 'stable'
        cache: true

    - name: ğŸ“¦ Get Dependencies
      run: flutter pub get

    - name: ğŸ—ï¸ Build Android APK
      run: |
        flutter build apk --release
        
    - name: ğŸ“ Rename APK
      run: |
        cp build/app/outputs/flutter-apk/app-release.apk qltinhoc-android.apk
        ls -la *.apk

    - name: ğŸ“¤ Upload Android APK
      uses: actions/upload-artifact@v4
      with:
        name: qltinhoc-android-${{ github.run_number }}
        path: qltinhoc-android.apk
        retention-days: 30

  # ==================== iOS BUILD ====================
  ios-build:
    if: github.event.inputs.build_ios != 'false'
    name: ğŸ iOS IPA Build
    runs-on: macos-latest
    timeout-minutes: 45

    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4

    - name: ğŸ”§ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        channel: 'stable'
        cache: true

    - name: ğŸ“¦ Get Dependencies
      run: flutter pub get

    - name: ğŸ Setup iOS
      run: |
        flutter precache --ios
        cd ios
        pod install --repo-update
        cd ..

    - name: ğŸ—ï¸ Build iOS (No Code Sign)
      run: |
        flutter build ios --release --no-codesign
        
    - name: ğŸ“¦ Create IPA
      run: |
        cd build/ios/iphoneos
        mkdir -p Payload
        cp -r Runner.app Payload/
        zip -r ../../../qltinhoc-ios-unsigned.ipa Payload/
        cd ../../..
        ls -la *.ipa

    - name: ğŸ“¤ Upload iOS IPA
      uses: actions/upload-artifact@v4
      with:
        name: qltinhoc-ios-${{ github.run_number }}
        path: qltinhoc-ios-unsigned.ipa
        retention-days: 30

  # ==================== WINDOWS BUILD ====================
  windows-build:
    if: github.event.inputs.build_windows != 'false'
    name: ğŸ–¥ï¸ Windows EXE Build
    runs-on: windows-latest
    timeout-minutes: 30

    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4

    - name: ğŸ”§ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        channel: 'stable'
        cache: true

    - name: ğŸ“¦ Get Dependencies
      run: flutter pub get

    - name: ğŸ–¥ï¸ Enable Windows Desktop
      run: flutter config --enable-windows-desktop

    - name: ğŸ—ï¸ Build Windows EXE
      run: flutter build windows --release

    - name: ğŸ“¦ Package Windows App
      run: |
        Compress-Archive -Path "build\windows\x64\runner\Release\*" -DestinationPath "qltinhoc-windows.zip"
        dir *.zip

    - name: ğŸ“¤ Upload Windows ZIP
      uses: actions/upload-artifact@v4
      with:
        name: qltinhoc-windows-${{ github.run_number }}
        path: qltinhoc-windows.zip
        retention-days: 30

  # ==================== BUILD SUMMARY ====================
  build-summary:
    name: ğŸ“‹ Build Summary
    runs-on: ubuntu-latest
    needs: [android-build, ios-build, windows-build]
    if: always()

    steps:
    - name: ğŸ“Š Build Results
      run: |
        echo "ğŸš€ QL TIN Há»ŒC - BUILD SUMMARY"
        echo "================================"
        echo "ğŸ¤– Android: ${{ needs.android-build.result }}"
        echo "ğŸ iOS: ${{ needs.ios-build.result }}"
        echo "ğŸ–¥ï¸ Windows: ${{ needs.windows-build.result }}"
        echo "================================"
        echo "ğŸ“¦ Artifacts will be available for 30 days"
        echo "ğŸ”— Download from Actions tab"
